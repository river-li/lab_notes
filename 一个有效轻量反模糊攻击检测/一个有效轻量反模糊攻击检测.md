# 针对PowerShell脚本的有效轻量反模糊攻击检测



#### title: Effective and Light-Weight Deobfuscation and Semantic-Aware Attack Detection for PowerShell Scripts

#### author: Qiongtu

#### date: 2019-10-19 

#### categories: - Paper



## Abstract &Introduction

  近几年，关于PowerShell的网络攻击，从高级持续性攻击、勒索软件、钓鱼邮件等到无档案攻击持续增长。由于PowerShell从设计上就是动态的而且可以在不同阶段构建不同的脚本片段，最新的基于PowerShell攻击检测的静态分析方法就无可避免的易于遭受模糊攻击。本文提出第一个有效且轻量的对于PowerShell脚本的反模糊攻击方法。为了启用基于语义的检测，作者利用经典的面向对象的关联挖掘算法确定PowerShell攻击的31个语义签名。实验结果表明，应用了反混淆方法，语义感知攻击检测系统的性能优于Windows Defender和VirusTotal平均为92.3％的真阳性率和0％的假阳性率。

  

  	作者的贡献包括：

- 基于模糊处理本质上限制了Powershell 攻击检测的有效性而设计出第一个有效轻量的针对PowerShell去模糊处理方法。运用一个全新的，基于生成字数的去模糊处理方法去定位可被恢复的脚本片段。

- 通过建立这样的去模糊处理方法，我们能够设计出第一个语义识别PowerShell攻击检测系统。运用经典的面向对象的关联挖掘算法去得到PowerShell攻击特征和基于恶意脚本集合的31个OOA规则。

- 本文提出的去模糊处理方法不仅有效提高了去模糊处理后的脚本与初始脚本的相似度，而且十分有效，5.4KB平均小于0.5秒。

  

---

## Background



1. 基于脚本的恶意软件探测

   - 动态探测

   - 静态探测

   - 模糊探测

     ![1.png]()

2. 去模糊处理

   - 二进制去模糊处理

   - 脚本去模糊处理

     

---

## Overview

​	 作者指出，虽然这个方法目标在于检测PowerShell，但可以应用于其他脚本语言。作者的主要观点是，模糊攻击的一般做法就是要在执行之前用已经模糊的脚本去恢复成未被模糊的部分。因此，对于混淆脚本，只要可以定位所有成对的脚本片段和它们对应的恢复逻辑，我们可以模拟每对的恢复过程，从而逐步还原脚本。

  	问题在于，如何精准确认这些脚本对。为了应对这个问题，作者提出这样的基于生成子树、在Powershell脚本抽象语法树（AST）层面上的的反模糊处理的方法，这同时也是模糊处理的最小单位。首先，作者用机器学习训练了一个分辨器去识别一颗生成子树是否被模糊处理，若是，则从下往上遍历AST去确认可被恢复的脚本片段，模拟恢复逻辑，还原未被模糊的脚本。

​	  基于此方法构建第一个语义感知PowerShell攻击检测系统，采用面向对象的关联挖掘算法去自动提取频繁出现的命令和函数集合，成为OOA规则，用于语义特征匹配。在恶意命令行脚本数据集中运用此方法，得到了31个OOA规则。

 	 为了评估PowerShell去混淆方法的性能和监测系统，作者从Github前500个库里收集了2342个良性样本，从安全博客、攻击分析白皮书、开源攻击库搜集了4141个恶意样本。实验结果显示，通过运用此方法，去模糊攻击样本与原样本的相似度从之前的0.5%提高到了80%，并且这个方法平均每5.4KB用时小于0.5秒，效率很高。实质上，通过这种方法，Windows Defender的阳性检测率从0.3%提升到了75%，VirusTotal从2.65%提升到了90%，而二者的假阳率几乎为0。

设计这样一个机制，用它作为关键建设部分来构建第一个语义感知PowerShell攻击检测系统。关于检测的过程大概分为三个方面:

1. 去混淆。
2. 训练和检测。
3. 用用场景：

​	相比于动态监测，基于去混淆的语义感知攻击检测系统有更高的代码覆盖率、更低的开销、也不必根据系统或解释器做出改动。与现有的静态检测的攻击检测相比，本文提出的方法对模糊处理更有弹性且易于说明。使用场景包括但不限于：

- 实时攻击检测。
- 大规模自动化恶意软件分析。





###  Motivation

几乎在所有的攻击中，PowerShell都被普遍用于下载和执行payload，同时也被利用来建立逆向壳或者收集信息。作者从两个方面提出了PowerShell攻击的挑战。





#### 关于通过PowerShell的“Living off the land”和无档案攻击。

前者是指通过尽可能少的文件和只用安全的工具躲避检测的攻击；后者是指不在磁盘留下任何痕迹的攻击。这两种攻击都成为了今年的流行。

PowerShell作为这样攻击方式的理想工具是有原因的，一方面，在win7,win server 2008R2之后，PowerShell被预先安装在所有windows电脑上。另一方面，作为性能优秀的第一方管理员工具，PowerShell易于触发所有重要的系统等级的操作。最后，PowerShell脚本可以从内存执行而不需要任何隔离，这能避开磁盘上的恶意文件和避开传统的基于文件的防护办法。前两者支持"living off the land"攻击，第三点让无档案攻击成为可能。而且攻击实施并不困难。



#### PowerShell的模糊处理技术。

模糊处理一向是躲避检测的最流行方案。二进制项目中逻辑结构模糊处理被广泛应用，有人尝试将其用于PowerShell和完善基于AST的模糊处理，但这种方法的有效性很局限。PowerShell对于代码和数据没有明确的划分，从逻辑上说执行模糊脚本的过程分为两步：1）计算在脚本中有不同含义的字符串2）重建原始脚本然后执行。在Token阶段这两步混合进行，增加了去混淆的难度。以下是对赛门铁克白皮书中的混淆处理的分析：

1. 随机化。随机化模糊处理是指攻击者可以对脚本做出随处改变而不影响执行与语义执行。这些技术包括whitespace randomization, case randomization, variable and function name randomization 以及 被PowerShell忽视的insertion characters。这些利用了PowerShell翻译器对于确定的脚本属性并不敏感的特性。其他的方法比如利用别名而不是全属性的命令也可以归于此类。这种类型的模糊处理只影响阅读而不是语义语法。

 2. 字符串篡改。这类技术包括string splitting,string reversing和string reordering。
 3. 解码。基于解码的模糊处理是现实中最普遍的。解码后模糊处理脚本反映了一小部分原始脚本信息。

​	

  **![2](1570367820196.png)**

#### PowerShell攻击检测模糊处理的有效性研究

实验理论：选择5种代表性的混合型模糊处理方案，所有都包含基本的随机化处理。实验所用的PowerShell脚本样本中，75个恶意样本来自开源攻击框架和安全博客，75个良性样本来自Github。这150个样本每个都经过上述5中模糊方案处理，随后与原始脚本作对比。计算报告恶意软件预警的反病毒引擎个数。

![3](1570369091568.png)

结果表明，所有四个方案都有效避开了所有最先进的反病毒引擎。平均预警数量从13.2跌到最多为3.1。





### Powershell去模糊处理

- 基于生成子树的去模糊处理方法

  可以分为五步：

  1. 将Powershell脚本解析成AST集合，在分配语句的两端添加链接
  2. 用分辨器去寻找经过模糊处理的子树，需要指出符合所有模糊处理特征的可能不是可以恢复的子树
  3. 模糊处理的片段被模拟还原成原始脚本片段
  4. 去模糊处理的片段被解析成新的AST集合取代模糊处理的子树
  5. 循环，直到检查不出模糊处理的子树

![4](1570377018102.png)



值得一提的挑战在于如何在第二阶段寻找匹配的模糊片段和可恢复片段。

- 提取可疑的子树

   采用微软的官方库来解析PowerShell脚本得到AST。一个传统的大约几个KB的脚本可能在AST中有上千个节点，这意味着查看所有生成子树开销很大。幸运的是只有两种去遍历被恢复的段落，通过管道或者变量，来减少要检查的开销；基于此，把广度优先遍历AST得到的可以树放入栈中。

- 基于生成子树的去混淆检测

  ​	现有的针对JavasScript和PowerShell的模糊检测都有很高的准确率。

  - 选择特征：

    1. 脚本段落的熵

       ![5](1570379141830.png)

    2. 符号长度

    3. AST类型分布

    4. AST的深度

       

- 基于模拟的还原

  启动PowerShell会话，在最后一步执行模糊片段的检测。如果脚本段落是可被还原的，返回值就是还原后的脚本片段；若返回值不是字符串，要么最后一步的模糊检测错误，要么现有的脚本段落不可以被还原，有两种情况之一，就把子树记为非模糊处理，并将其送入下一个模糊处理子树。

- AST更新

  得到被还原的脚本段落之后要把它解析为一个新的AST树并更新AST。

- 后处理

  恢复后的脚本和原始脚本仍然是有差异的，大部分差异都是由于模糊处理引入，为了帮助解释器更好理解各字符串的含义，模糊处理引入额外的符号。

  

![6](1570380134957.png)



### 语义感知PowerShell攻击检测

- 如何得到OOA规则

  1. 利用FP-成长算法去生成常用模型

  2. 选择其中满足支持和信心成绩高于阈值的模型

     其中，支持意味着恶意代码的可能性，信心意味着通用性，其定义如下：

     ![7](1570414902634.png)

I={I1,...,Im}是命令的集合，count函数返回值是在DB中满足I∪{Obj}的记录个数。



- 检测方面

  将去模糊处理的脚本解析为项目及，与预先得到的OOA规则匹配。

  

***



## 评估

- 对基于生成子树的去模糊处理性能的评估

  1. 评估是否得到包含模糊处理的最小规模的生成树

  2. 认证模糊处理的质量，通过比较去模糊处理的脚本段落和原始段落的相似度，用到了代码克隆探测方法。

  3. 评估去模糊处理的效率，通过计算对用不同模糊方法处理的脚本去模糊处理的平均耗时

  4. 评估去模糊处理方法在在PowerShell攻击检测中的优势

     

- 评估结果

  实验环境，Intel Core i5-7400 处理器 3.5GHz, 4核，16GB内存，windows 10 64位专业版。

  1. 模糊检测准确率：

![8](1570416083986.png)





2. 还原质量：

![9](1570416232277.png) 

3. 去模糊处理的效率

![10](1570416320821.png)



4. 去模糊脚本的攻击检测

   ![11](1570416428090.png)

5. 与最先进的PowerShell检测方法的比较

   ![12](1570416583591.png)

6. 去模糊处理中使用的技术分解分析

   ![13](1570416707013.png)



***

## 讨论

1. 实验方法的通用性

   实验中基于生成子树的去模糊处理方法虽然用于PowerShell，但这个设计本身不需要关于PowerShell的明确的特征。这个设计可以满足任何通过隐藏脚本片作为字符串覆盖语义的模糊处理方法。此设计只需要一个解析器和一个无需调整的解释器，且都有可用的官方工具。因此要想构建去模糊处理系统额外的工作只有，搜集模糊子树的样本，训练模糊探测器。

2. 隐患

   - 反调试

     对于更先进的攻击方法，唯一的机会就是在攻击时捕获脚本行为，这是本文提出的方法就不适用。但这种攻击也要付出比较大的代价。

   - 逻辑模糊

     本文关注文本模糊办法，逻辑模糊是另一种模糊办法，目的是扰乱控制流和数据流，这种模糊方法与文本模糊是正交关系，所以本文并不涉及。实际上虽然逻辑模糊很难恢复，但对于函数和命令包含足够语义的PowerShell而言，仅仅是逻辑模糊还不足以躲避探测。

     

***

## 总结与评价

​	本文提出第一个有效且轻量的对于PowerShell脚本的反模糊攻击方法。基于此新反模糊攻击方法，设计出第一个语义感知PowerShell攻击检测系统。为了启用基于语义的检测，作者利用经典的面向对象的关联挖掘算法确定PowerShell攻击的31个OOA规则。实验结果表明，应用了反混淆方法，语义感知攻击检测系统是有用且高效的。此外，应用此方法，Windows Defender和 Virus-Total的攻击检测率从0.3%和2.65%提高到了75.0%和90.0%，本文所提出的语义感知攻击探测系统以92.3%的TPR和0%的FPR优越于Windows Defender和 Virus-Total。

​	

